<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/base :: layout(~{::title}, ~{::section})}">
<head>
    <title th:text="${title} + ' - Taxi Booking System'">Bookings - Taxi Booking System</title>
</head>
<body>
    <section class="container py-4">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 th:text="${title}">Bookings</h2>
            <a th:href="@{/bookings/new}" class="btn btn-primary">
                <i class="bi bi-plus-circle me-2"></i>New Booking
            </a>
        </div>
        
        <!-- Filters -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <form id="filterForm" class="row g-3">
                    <!-- Status Filter -->
                    <div class="col-md-3">
                        <label for="statusFilter" class="form-label">Status</label>
                        <select class="form-select" id="statusFilter">
                            <option value="">All Statuses</option>
                            <option value="PENDING">Pending</option>
                            <option value="CONFIRMED">Confirmed</option>
                            <option value="IN_PROGRESS">In Progress</option>
                            <option value="COMPLETED">Completed</option>
                            <option value="CANCELLED">Cancelled</option>
                            <option value="NO_SHOW">No Show</option>
                        </select>
                    </div>
                    
                    <!-- Vehicle Type Filter -->
                    <div class="col-md-3">
                        <label for="vehicleTypeFilter" class="form-label">Vehicle Type</label>
                        <select class="form-select" id="vehicleTypeFilter">
                            <option value="">All Types</option>
                            <option value="SEDAN">Sedan</option>
                            <option value="SUV">SUV</option>
                            <option value="VAN">Van</option>
                            <option value="LUXURY">Luxury</option>
                        </select>
                    </div>
                    
                    <!-- Date Range Filter -->
                    <div class="col-md-4">
                        <label for="dateRangeFilter" class="form-label">Date Range</label>
                        <div class="input-group">
                            <input type="date" class="form-control" id="startDate">
                            <span class="input-group-text">to</span>
                            <input type="date" class="form-control" id="endDate">
                        </div>
                    </div>
                    
                    <!-- Search -->
                    <div class="col-md-2">
                        <label for="searchInput" class="form-label">Search</label>
                        <input type="text" class="form-control" id="searchInput" 
                               placeholder="Booking ID, Location...">
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Bookings Table -->
        <div class="card shadow">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>
                                <a href="#" class="text-decoration-none text-dark" data-sort="bookingId">
                                    Booking ID
                                    <i class="bi bi-arrow-down-up"></i>
                                </a>
                            </th>
                            <th>
                                <a href="#" class="text-decoration-none text-dark" data-sort="pickupTime">
                                    Pickup Time
                                    <i class="bi bi-arrow-down-up"></i>
                                </a>
                            </th>
                            <th>Pickup Location</th>
                            <th>Dropoff Location</th>
                            <th>Vehicle Type</th>
                            <th>
                                <a href="#" class="text-decoration-none text-dark" data-sort="status">
                                    Status
                                    <i class="bi bi-arrow-down-up"></i>
                                </a>
                            </th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="booking : ${bookings}" th:data-booking-id="${booking.bookingId}">
                            <td>
                                <a th:href="@{/bookings/{id}(id=${booking.bookingId})}" 
                                   class="text-decoration-none" th:text="${booking.bookingId}">
                                    BOOKING-123
                                </a>
                            </td>
                            <td th:text="${#temporals.format(booking.pickupTime, 'dd/MM/yyyy HH:mm')}">
                                01/01/2024 12:00
                            </td>
                            <td th:text="${booking.pickupLocation}">123 Main St</td>
                            <td th:text="${booking.dropoffLocation}">456 Park Ave</td>
                            <td th:text="${booking.vehicleType}">Sedan</td>
                            <td>
                                <span th:class="${'badge ' + 
                                    (booking.status == T(com.taxibooking.model.Booking.BookingStatus).PENDING ? 'bg-warning' : 
                                     booking.status == T(com.taxibooking.model.Booking.BookingStatus).CONFIRMED ? 'bg-info' :
                                     booking.status == T(com.taxibooking.model.Booking.BookingStatus).IN_PROGRESS ? 'bg-primary' :
                                     booking.status == T(com.taxibooking.model.Booking.BookingStatus).COMPLETED ? 'bg-success' :
                                     booking.status == T(com.taxibooking.model.Booking.BookingStatus).CANCELLED ? 'bg-danger' :
                                     'bg-secondary')}"
                                      th:text="${booking.status}">
                                    PENDING
                                </span>
                            </td>
                            <td>
                                <div class="btn-group">
                                    <a th:href="@{/bookings/{id}(id=${booking.bookingId})}" 
                                       class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <button th:if="${booking.status == T(com.taxibooking.model.Booking.BookingStatus).PENDING}"
                                            class="btn btn-sm btn-outline-success"
                                            th:onclick="'assignDriver(\'' + ${booking.bookingId} + '\')'">
                                        <i class="bi bi-person-plus"></i>
                                    </button>
                                    <button th:if="${booking.status == T(com.taxibooking.model.Booking.BookingStatus).CONFIRMED}"
                                            class="btn btn-sm btn-outline-primary"
                                            th:onclick="'startRide(\'' + ${booking.bookingId} + '\')'">
                                        <i class="bi bi-play-circle"></i>
                                    </button>
                                    <button th:if="${booking.status == T(com.taxibooking.model.Booking.BookingStatus).IN_PROGRESS}"
                                            class="btn btn-sm btn-outline-success"
                                            th:onclick="'completeRide(\'' + ${booking.bookingId} + '\')'">
                                        <i class="bi bi-check-circle"></i>
                                    </button>
                                    <button th:if="${booking.status == T(com.taxibooking.model.Booking.BookingStatus).PENDING}"
                                            class="btn btn-sm btn-outline-danger"
                                            th:onclick="'cancelBooking(\'' + ${booking.bookingId} + '\')'">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(bookings)}">
                            <td colspan="7" class="text-center py-4">
                                <i class="bi bi-inbox display-4 text-muted"></i>
                                <p class="mt-2 text-muted">No bookings found</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>
    
    <!-- Action Modals -->
    <!-- Assign Driver Modal -->
    <div class="modal fade" id="assignDriverModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Assign Driver</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="assignDriverForm">
                        <input type="hidden" id="bookingIdForAssignment">
                        <div class="mb-3">
                            <label for="driverSelect" class="form-label">Select Driver</label>
                            <select class="form-select" id="driverSelect" required>
                                <option value="">Choose a driver...</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="confirmDriverAssignment()">
                        Assign Driver
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Complete Ride Modal -->
    <div class="modal fade" id="completeRideModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Complete Ride</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="completeRideForm">
                        <input type="hidden" id="bookingIdForCompletion">
                        <div class="mb-3">
                            <label for="distance" class="form-label">Distance (km)</label>
                            <input type="number" class="form-control" id="distance" step="0.1" required>
                        </div>
                        <div class="mb-3">
                            <label for="fare" class="form-label">Fare</label>
                            <input type="number" class="form-control" id="fare" step="0.01" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="confirmRideCompletion()">
                        Complete Ride
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Bootstrap tooltips and popovers
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            // Initialize modals
            const assignDriverModal = new bootstrap.Modal(document.getElementById('assignDriverModal'));
            const completeRideModal = new bootstrap.Modal(document.getElementById('completeRideModal'));
            
            // Filter and search functionality
            const filterForm = document.getElementById('filterForm');
            const searchInput = document.getElementById('searchInput');
            const statusFilter = document.getElementById('statusFilter');
            const vehicleTypeFilter = document.getElementById('vehicleTypeFilter');
            const startDate = document.getElementById('startDate');
            const endDate = document.getElementById('endDate');
            
            function applyFilters() {
                const searchTerm = searchInput.value.toLowerCase();
                const statusValue = statusFilter.value;
                const vehicleTypeValue = vehicleTypeFilter.value;
                const startDateValue = startDate.value;
                const endDateValue = endDate.value;
                
                document.querySelectorAll('tbody tr').forEach(row => {
                    if (row.querySelector('td:first-child').textContent === 'No bookings found') {
                        return;
                    }
                    
                    const bookingId = row.querySelector('td:first-child').textContent;
                    const pickupTime = row.querySelector('td:nth-child(2)').textContent;
                    const pickupLocation = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
                    const dropoffLocation = row.querySelector('td:nth-child(4)').textContent.toLowerCase();
                    const vehicleType = row.querySelector('td:nth-child(5)').textContent;
                    const status = row.querySelector('td:nth-child(6) span').textContent;
                    
                    const matchesSearch = bookingId.toLowerCase().includes(searchTerm) ||
                                        pickupLocation.includes(searchTerm) ||
                                        dropoffLocation.includes(searchTerm);
                    
                    const matchesStatus = !statusValue || status === statusValue;
                    const matchesVehicleType = !vehicleTypeValue || vehicleType === vehicleTypeValue;
                    
                    let matchesDate = true;
                    if (startDateValue || endDateValue) {
                        const bookingDate = new Date(pickupTime.split(' ')[0].split('/').reverse().join('-'));
                        if (startDateValue && bookingDate < new Date(startDateValue)) {
                            matchesDate = false;
                        }
                        if (endDateValue && bookingDate > new Date(endDateValue)) {
                            matchesDate = false;
                        }
                    }
                    
                    row.style.display = matchesSearch && matchesStatus && matchesVehicleType && matchesDate ? '' : 'none';
                });
            }
            
            filterForm.addEventListener('input', applyFilters);
            searchInput.addEventListener('input', applyFilters);
            
            // Sorting functionality
            document.querySelectorAll('th a[data-sort]').forEach(header => {
                header.addEventListener('click', function(e) {
                    e.preventDefault();
                    const sortBy = this.dataset.sort;
                    const tbody = document.querySelector('tbody');
                    const rows = Array.from(tbody.querySelectorAll('tr'));
                    
                    // Remove sorting indicators
                    document.querySelectorAll('th a i').forEach(icon => {
                        icon.className = 'bi bi-arrow-down-up';
                    });
                    
                    // Add sorting indicator
                    const icon = this.querySelector('i');
                    icon.className = icon.className.includes('up') ? 
                        'bi bi-arrow-down' : 'bi bi-arrow-up';
                    
                    // Sort rows
                    rows.sort((a, b) => {
                        if (a.querySelector('td:first-child').textContent === 'No bookings found') {
                            return 1;
                        }
                        if (b.querySelector('td:first-child').textContent === 'No bookings found') {
                            return -1;
                        }
                        
                        let aValue, bValue;
                        switch (sortBy) {
                            case 'bookingId':
                                aValue = a.querySelector('td:first-child').textContent;
                                bValue = b.querySelector('td:first-child').textContent;
                                break;
                            case 'pickupTime':
                                aValue = new Date(a.querySelector('td:nth-child(2)').textContent.split(' ')[0].split('/').reverse().join('-'));
                                bValue = new Date(b.querySelector('td:nth-child(2)').textContent.split(' ')[0].split('/').reverse().join('-'));
                                break;
                            case 'status':
                                aValue = a.querySelector('td:nth-child(6) span').textContent;
                                bValue = b.querySelector('td:nth-child(6) span').textContent;
                                break;
                        }
                        
                        if (icon.className.includes('up')) {
                            return aValue > bValue ? 1 : -1;
                        } else {
                            return aValue < bValue ? 1 : -1;
                        }
                    });
                    
                    // Reorder rows
                    rows.forEach(row => tbody.appendChild(row));
                });
            });
        });
        
        // Action functions
        function assignDriver(bookingId) {
            document.getElementById('bookingIdForAssignment').value = bookingId;
            
            // Fetch available drivers
            fetch('/drivers/api/available')
                .then(response => response.json())
                .then(drivers => {
                    const select = document.getElementById('driverSelect');
                    select.innerHTML = '<option value="">Choose a driver...</option>';
                    drivers.forEach(driver => {
                        const option = document.createElement('option');
                        option.value = driver.userId;
                        option.textContent = `${driver.fullName} (${driver.vehicleType})`;
                        select.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error fetching drivers:', error);
                    alert('Failed to load available drivers');
                });
            
            new bootstrap.Modal(document.getElementById('assignDriverModal')).show();
        }
        
        function confirmDriverAssignment() {
            const bookingId = document.getElementById('bookingIdForAssignment').value;
            const driverId = document.getElementById('driverSelect').value;
            
            if (!driverId) {
                alert('Please select a driver');
                return;
            }
            
            fetch(`/bookings/${bookingId}/assign?driverId=${driverId}`, {
                method: 'POST'
            })
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    throw new Error('Failed to assign driver');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to assign driver');
            });
        }
        
        function startRide(bookingId) {
            if (confirm('Are you sure you want to start this ride?')) {
                fetch(`/bookings/${bookingId}/start`, {
                    method: 'POST'
                })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        throw new Error('Failed to start ride');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to start ride');
                });
            }
        }
        
        function completeRide(bookingId) {
            document.getElementById('bookingIdForCompletion').value = bookingId;
            new bootstrap.Modal(document.getElementById('completeRideModal')).show();
        }
        
        function confirmRideCompletion() {
            const bookingId = document.getElementById('bookingIdForCompletion').value;
            const distance = document.getElementById('distance').value;
            const fare = document.getElementById('fare').value;
            
            if (!distance || !fare) {
                alert('Please enter both distance and fare');
                return;
            }
            
            fetch(`/bookings/${bookingId}/complete?distance=${distance}&fare=${fare}`, {
                method: 'POST'
            })
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    throw new Error('Failed to complete ride');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to complete ride');
            });
        }
        
        function cancelBooking(bookingId) {
            if (confirm('Are you sure you want to cancel this booking?')) {
                fetch(`/bookings/${bookingId}/cancel`, {
                    method: 'POST'
                })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        throw new Error('Failed to cancel booking');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to cancel booking');
                });
            }
        }
    </script>
</body>
</html> 